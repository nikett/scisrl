<html>
  <head>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js'></script>
    <!-- end of required libraries -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/lodash@4.17.4/lodash.min.js'></script>
    <script src='https://www.promisejs.org/polyfills/promise-7.0.4.min.js'></script>
    <style>
    htitle {font-size: 25px; font-weight: 400; color: #dd0000;}
    header {font-size: 22px; font-weight: 400; color: #555555;}
    note {font-size: 22px; font-weight: 400; color: #dd0000;}
    answer {font-size: 20px; font-weight: 400; color: #000000;}
    badanswer {font-size: 20px; font-weight: 400; color: #ff0000;}
    goodanswer {font-size: 20px; font-weight: 400; color: #00dd00;}
    char {font-size: 20px; font-weight: 400; color: #0000dd;}
    timew {font-size: 20px; font-weight: 400; color: #00ddff;}
    obj {font-size: 20px; font-weight: 400; color: #ff00dd;}
    tab1 { padding-left: 2em; }
      textarea {
        display: block;
        margin-left: auto;
        margin-right: auto;
        font-size: 16pt!important;
		 width: 180px!important;
 		 height: 45px!important;
      }
      #button-div {
        margin-bottom: 10px;
      }
      #counter {
        margin: 0 10px;
        font-size: 20pt;
        font-weight: bold;
      }
      img {
        height: 200px;
      }
      #rules {
          border-collapse: collapse;
          width: 100%;
      }
      #rules th {
          padding-top: 12px;
          padding-bottom: 12px;
          border: 1px solid #000000;
          padding: 8px;
          text-align: center;
          background-color: #4CAF50;
          font-size: 20px; font-weight: 400; color: white;
      }
      #rules td {
          border: 1px solid #000000;
          padding: 8px;
          font-size: 18px; font-weight: 400; color: black;
      }

      #examples {
          border-collapse: collapse;
      }
      #examples td {
          border: 2px solid #888888;
          background-color: #f8f8f8;
          padding: 8px;
          width: 700;
          vertical-align: top;
          font-size: 18px; font-weight: 400; color: black;
      }

      .selected {
        background-color: red;
      }

      .disabled {
        color: #ff00dd;
      }
    </style>
  </head>
  <body>
    <div class='container-fluid'>
    <div class='container'>
      <htitle>In the given sentences</htitle><br>
      <htitlesm>1. Mark: actions by clicking on words in a sentence: these phrases have to be contiguous words.</htitlesm><br>
      <htitlesm>2. If there are no meaningful actions in the sentence, select 'There are no actions.'</htitlesm><br>
      <htitlesm>3. <b>DO NOT</b> mark abstract verbs (e.g., is, defined, etc.), and do not include negations (instead of <obj>do not move</obj>, prefer <obj> move </obj>).
          <br>Do not mark adjectives unless they are part of the action, e.g. prefer <obj>gets sufficiently cold</obj>
          instead of <obj>get cold</obj> to avoid skipping over a word in a phrase.</htitlesm><br>
    <p>&nbsp;</p>
    <br>
    <header>Examples</header>
    <br>


    <table id="examples">
      <tr>
      <td>
          Plants <obj>require</obj> air, water, nutrients, and light in order to <obj>live</obj>
          and <obj>survive</obj>.
      </td>
      </tr>
      <tr>
      <td>
          When a chemical change <obj>takes place</obj>, new substances <obj>are formed</obj>.
      </td>
      </tr>
      <tr>
      <td>
          When heat <obj>is added</obj> to the water, the molecules <obj>move</obj> faster
          and their bonds will not <obj>stay</obj> the same.
      </td>
      </tr>
      <tr>
      <td>
          The water molecule <obj>is composed of</obj> two hydrogen atoms , each <obj>linked</obj> by a bond.
      </td>
      </tr>
      <tr>
      <td>
        The glass <obj>gets cold</obj> enough to make it possible to <obj>condense</obj> <br>
          water vapor in the air into tiny droplets that <obj>deposit</obj> on the surface.
      </td>
      </tr>
    </table>

    <br>
    <!--<div class='container-fluid'>-->
        <!--<div class='col-lg-4 text-center'>-->
          <!--{% include 'simpleamt.html' %}-->
         <!--</div>-->
    <!--<hr>-->
  </div>
    <br><br><hr><br><br>
    <div class='col-lg-4 text-center'> {% include 'simpleamt.html' %} </div>
        <br><br>

      <div class="questions"></div>
    <script>

var ENABLES = 'enable',
    ENABLED_BY = 'enabled_by',
    PREVENTS = 'prevent',
    PREVENTED_BY = 'prevented_by',
    NONE = 'none';
var EVENT_RELATIONS = [
  {
    value: ENABLES,
    text: 'enables'
  },
  {
    value: ENABLED_BY,
    text: 'is enabled by'
  },
  {
    value: PREVENTS,
    text: 'prevents'
  },
  {
    value: PREVENTED_BY,
    text: 'is prevented by'
  },
  {
    value: NONE,
    text: 'has no effect on'
  }
];

function render() {
  var tokens = {{formatted_description | safe}}[0];
  var verbSpans = {{verbids}};
  var $questions = $('.questions');

  var verbAnswers = [
    {
      "verb": {
        "phrase": "change",
        "indices": [
          10
        ]
      },
      "questions": {
        "who": null,
        "what": {
          "phrase": "the arrangement of particles",
          "indices": [
            5,
            6,
            7,
            8
          ]
        },
        "where": null,
        "whereFrom": null,
        "whereTo": null,
        "when": null,
        "prereq": null,
        "outcome": null
      }
    },
    {
      "verb": {
        "phrase": "stay",
        "indices": [
          23
        ]
      },
      "questions": {
        "who": null,
        "what": {
          "phrase": "the mass , number of atoms and number of molecules",
          "indices": [
            12,
            13,
            14,
            15,
            16,
            17,
            18,
            19,
            20,
            21
          ]
        },
        "where": null,
        "whereFrom": null,
        "whereTo": null,
        "when": {
          "phrase": "During a physical change",
          "indices": [
            0,
            1,
            2,
            3
          ]
        },
        "prereq": null,
        "outcome": null
      }
    }
  ];

  /*
  askVerbQuestions($questions, tokens, verbSpans).then(function(verbAnswers) {
    console.log(verbAnswers);
    */
  askEventRelationQuestions($questions, verbAnswers).then(function(eventRelationAnswers) {
    console.log(eventRelationAnswers);
  }).catch(function(error) {
    console.error(error);
  });
}

function askVerbQuestions($container, tokens, verbSpans) {
  var verbIndices = _.flatten(verbSpans.map(function(span) {
    return _.range(span[0], span[1]);
  }));

  return Promise.all(verbSpans.map(function(verbSpan) {
    return askQuestionsForVerb($container, tokens, verbIndices, verbSpan);
  }));
}

function askEventRelationQuestions($container, verbAnswers) {
  var actions = verbAnswers.map(function(answer) {
    return {
      verb: answer.verb,
      who: answer.questions.who,
      what: answer.questions.what,
      phrase: getActionPhrase(
        answer.verb,
        answer.questions.who,
        answer.questions.what
      )
    };
  });

  function getRelation(actionIndex1, actionIndex2) {
    return new Promise(function(resolve, reject) {
      var $questionContainer = $('<div>')
        .appendTo($container);

      $('<span>')
        .text(actions[actionIndex1].phrase)
        .appendTo($questionContainer);

      var relation;
      radioButtons('relation', EVENT_RELATIONS, function(selected) {
        relation = selected;
      }).appendTo($questionContainer);

      $('<span>')
        .text(actions[actionIndex2].phrase)
        .appendTo($questionContainer);

      $('<button>')
        .text('Submit')
        .click(function() {
          if (!relation) {
            return alert('Please select a relation between the two events.');
          }

          resolve(relation);
        })
        .appendTo($questionContainer);
    });
  }

  return Promise.all(pairs(actions.length).map(function(indices) {
    return getRelation(indices[0], indices[1]).then(function(relation) {
      return Promise.resolve(canonicalizeRelation(indices, relation));
    });
  }));
}

function radioButtons(name, options, onChange) {
  var $form = $('<form>');

  options.forEach(function(option) {
    radioButton(name, option.value, option.text)
      .appendTo($form)
      .find('input')
      .change(function() {
        if ($(this).prop('checked')) {
          onChange(option.value);
        }
      });
  });

  return $form;
}

function radioButton(name, value, text) {
  var $label = $('<label>')
  $('<input>')
    .attr('type', 'radio')
    .attr('name', name)
    .attr('value', value)
    .appendTo($label);
  $('<span>')
    .text(text)
    .appendTo($label);
  return $label;
}

function pairs(n) {
  var pairs = [];
  for (var i = 0; i < n - 1; i++) {
    for (var j = i + 1; j < n; j++) {
      pairs.push([i, j]);
    }
  }
  return pairs;
}

// 0 ENABLED_BY 1 -> 1 ENABLES 0
function canonicalizeRelation(indices, relation) {
  var forwards = !(relation === ENABLED_BY || relation === PREVENTED_BY);
  var source = forwards ? indices[0] : indices[1];
  var target = forwards ? indices[1] : indices[0];

  var relationType = relation;
  if (relation === ENABLED_BY) {
    relationType = ENABLES;
  } else if (relation === PREVENTED_BY) {
    relationType = PREVENTS;
  }

  return {
    source: source,
    target: target,
    relation: relationType
  };
}

function askQuestionsForVerb($container, tokens, verbIndices, verbSpan) {
  var verb = {
    phrase: tokens.slice(verbSpan[0], verbSpan[1]).join(' '),
    indices: _.range(verbSpan[0], verbSpan[1])
  };

  var $questionContainer = $('<div>')
    .attr('id', verb.phrase)
    .appendTo($container);
  $('<h3>').text(verb.phrase)
    .appendTo($questionContainer);

  var who, what, where, whereFrom, whereTo, when, prereq, outcome;

  function askQuestion(prefix, suffix) {
    var phrase = getActionPhrase(verb, who, what);
    var $question = $('<div>').appendTo($questionContainer);
    $('<p>')
      .text(prefix + ' "' + phrase + '"' + (suffix ? ' ' + suffix : '') + '?')
      .appendTo($question);
    var takenIndices = _.flatten([
      verbIndices,
      who ? who.indices : [],
      what ? what.indices : []
    ]);
    return getSpan($question, tokens, takenIndices).then(function(selectedIndices) {
      if (_.isEmpty(selectedIndices)) {
        return Promise.resolve(null);
      }

      return Promise.resolve({
        phrase: getTokens(tokens, selectedIndices), 
        indices: selectedIndices
      });
    });
  }

  function complete() {
    return Promise.resolve({
      verb: verb,
      questions: {
        who: who,
        what: what,
        where: where,
        whereFrom: whereFrom,
        whereTo: whereTo,
        when: when,
        prereq: prereq,
        outcome: outcome
      }
    });
  }

  return askQuestion('Who').then(function(selected) {
    who = selected;
    return askQuestion('What do');
  }).then(function(selected) {
    what = selected;

    if (!who && !what) {
      return Promise.reject();
    }

    return askQuestion('Where do')
  }).then(function(selected) {
    where = selected;
    return askQuestion('Where do', 'from');
  }).then(function(selected) {
    whereFrom = selected;
    return askQuestion('Where do', 'to');
  }).then(function(selected) {
    whereTo = selected;
    return askQuestion('When');
  }).then(function(selected) {
    when = selected;
    return askQuestion('What thing is the main pre-requisite for');
  }).then(function(selected) {
    prereq = selected;
    return askQuestion('What thing is the main outcome from');
  }).then(function(selected) {
    outcome = selected;
    return complete();
  }).catch(function(error) {
    if (error) {
      return Promise.reject(error);
    }

    return complete();
  });
}

function getSpan($container, tokens, takenIndices) {
  return new Promise(function(resolve, reject) {
    var $form = $('<form>');
    var selected = [];

    tokens.forEach(function(token, index) {
      var $button = $('<input type="button"/>')
      $button.val(token);
      $button.click(function() {
        $(this).toggleClass('selected');

        if (!_.includes(selected, index)) {
          selected.splice(_.sortedIndex(selected, index), 0, index);
        } else {
          selected.splice(selected.indexOf(index), 1);
        }
      });

      if (_.includes(takenIndices, index)) {
        $button.prop('disabled', true);
        $button.addClass('disabled');
      }

      $button.appendTo($form);
    });

    $submitButtons = $('<div class="submit-buttons">').appendTo($form);

    $('<input type="button" value="Submit"/>')
      .click(function() {
        if (selected.length === 0) {
          return alert('Please select at least one word.');
        }

        if (!isContiguous(selected)) {
          return alert('Please select a contiguous span of words.');
        }

        $form.remove();
        $('<p>').text(getTokens(tokens, selected)).appendTo($container);
        resolve(selected);
      })
      .appendTo($submitButtons);

    $('<input type="button" value="Invalid"/>')
      .click(function() {
        $form.remove();
        $('<p>').text('N/A').appendTo($container);
        resolve(null);
      })
      .appendTo($submitButtons);

    $form.appendTo($container);
  });
}

function getActionPhrase(verb, who, what) {
  if (who && what) return joinSpans([who, verb, what]);
  if (who) return joinSpans([who, verb]);
  if (what) return joinSpans([what, verb]);
  return joinSpans([verb]);
}

function joinSpans(spans) {
  return spans.map(function(span) {
    return span.phrase;
  }).join(' ');
}

function isContiguous(indices) {
  if (indices.length <= 1) {
    return true;
  }

  for (var i = 1; i < indices.length; i++) {
    if (indices[i] !== indices[i - 1] + 1) {
      return false;
    }
  }

  return true;
}

function getTokens(tokens, indices) {
  if (_.isEmpty(indices)) {
    return null;
  }

  return indices.map(i => tokens[i]).join(' ');
}

// Define some default input.
var DEFAULT_INPUT = [
'{{image_id}}'
];


// Descriptions of images, parallel to input.
var descriptions = [];

// Some variables to track state of the HIT.
var idx = 0;
var enabled = false;

function main() {
  // If this is a HIT on AMT, then replace the default input with the real input.
  input = simpleamt.getInput(DEFAULT_INPUT);

  // Enable the UI if the HIT is not in preview mode.
  if (!simpleamt.isPreview()) {
    enable_hit();
  }

  // Set up the descriptions.
  // _.each(input, function() { descriptions.push(''); });

  render();
}

// Enable the UI.
function enable_hit() {
  enabled = true;

  // Enable components
  <!--$('#next-btn').click(function() { set_idx(idx + 1) });-->
  <!--$('#prev-btn').click(function() { set_idx(idx - 1) });-->
  $('#setting').prop('disabled', false);
  $('#submit-btn').prop('disabled', false);

  // Set up submit handler.
  simpleamt.setupSubmit();
  $('#submit-btn').click(function() {
    if (descriptions.length < 1) {
      alert('Make sure to mark the actions, or select -There are no actions- if there are none');
      return false;
    }
    var output = {'image_url': input[0], 'description': descriptions}
    simpleamt.setOutput(output);
  });
}

main();
    </script>
  </div>
  </body>
</html>
